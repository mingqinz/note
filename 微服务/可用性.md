# 可用性



##  隔离

> 隔离，本质上是对系统或资源进行分割，从而实现当系统发生故障时能限定传播范围和影响范围，即发生故障后只有出问题的服务不可用，保证其他服务仍然可用

#### 服务隔离

- 动静分离 

> 思路上加速/缓存变换频次小的

1、cpu cache line 的false sharing

内存对齐：CPU cache  是以 cache line 为单位的。一次读取一个cache line的数据进入缓存。当多个CPU内核同时访问一个cache line中的数据时会产生伪共享(False Sharing)，产生性能损失。C++中声明对齐变量可以使用  alignas(n)  ，即以n字节对齐。并行编程中尽量避免同时访问一个cache line中的资源。 

作者：yaobrother
链接：https://www.zhihu.com/question/307351068/answer/576670796

2、数据库mysql表设计，避免频繁的bufferpool 频繁过期，隔离动静表

3、架构设计中的图片、静态资源等缓存加速

4、cdn静态资源和动态api分离

[边缘计算](https://zhuanlan.zhihu.com/p/59899560)

- 读写分离

主从、replicaset、CQRS

[cqrs](https://zhuanlan.zhihu.com/p/115685384)

#### 轻重隔离

- 核心

业务按level进行资源池划分，隔离核心和非核心资源池（机器资源和依赖资源）

多集群，通过冗余资源来提升吞吐和容灾

- 快慢

把服务吞吐想象成一个池子，设置快慢池。如：日志分开info和error日志

连接池分 慢查询链接和正常连接

- 热点

针对经常访问的数据，主动预热，进行缓存。 将热点数据进行localcache



#### 物理隔离

- 线程

线程池隔离，某个池子只处理某个业务，当某个业务出故障，不至于把所有服务的池子占满。

信号量，每个请求先获取到信号量，才能进行处理。

- 进程、集群、机房

docker化，多集群

#### 故障的case 

- nginx入口故障，影响全机房的流量
- 缩略图服务，被大量实时缩略图吃完资源，导致正常的小图缩略被丢弃
- 单机多数据库实例 cgroup 未隔离，大sql引起集体故障
- info日志量过大，导致error日志采集延迟

## 超时控制

> 超时控制，组件需要能够快速失效(fail fast)。不希望请求等到断开实例直到超时。这会浪费资源，还会影响用户体验

- 网络传递具有不确定性

- 客户端和服务端不一致的超时策略导致资源浪费

  客户端的超时时间小于服务端，导致客户端大量超时

- 默认值策略

  基础库进行默认值配置，还有配置防御，如果传入的配置有问题，直接panic

- 高延迟服务导致client浪费资源等待，使用资源等待，使用超时传递：进程间传递+跨进程传递

超时控制是微服务可用性的第一道关，良好的超时策略，可以让服务不堆积请求，尽快清空高延迟的请求，释放goroutine



#### 超时

- 双峰分布：95%的请求耗时在100ms，5%的请求永远不会完成（长超时）

- 对于监控，不要只要mean，要看耗时平均分布，比如95th 99th
- 设置合理的超时，拒绝超长超时，或者当server不可用要主动失败

根据99 和 95 的请求来设置超时时间



服务器之间时钟同步

[ntp授时](https://www.zhihu.com/question/20089241)



#### 故障case

- SLB nginx 没配置超时导致连锁故障

- 服务依赖的DB连接池没配置超时，导致请求阻塞，最终服务集体oom

- 下游服务发版导致耗时增加，上游服务配置超时过短，导致上游集体请求失败



## 过载保护

> 计算系统临近过载时的峰值吞吐作为限流的阈值来进行流量控制，达到系统保护

#### 令牌桶算法

存放固定容量令牌的桶，按照固定速率往桶里加令牌。

Token-bucket rate limit /x/time/rate

#### 漏桶算法

固定容量的漏桶，按照固定速率流出水滴

/go.uber.org/ratelimit



令牌桶和漏斗桶防护思路，都是设定一个指标，当超过改指标就阻止或者减少流量继续进入，当系统负责降低到某一个水平之后，在恢复流量。但其通常是被动的，其实际效果取决于限流阈值设置是否合理，但往往设置合理不是一件容易的事情



- 服务器在临近过载时，主动抛弃一定量的负载，进行自保

- 在系统稳定的前提下，保持系统的吞吐量

常见做法：[利特尔法则](https://zhuanlan.zhihu.com/p/65687548)

- cpu、内存作为信号量进行节流

[滑动均值](https://www.cnblogs.com/y1ran/p/12149615.html?utm_source=tuicool)

- 队列管理，队列长度、lifo

- 可控延迟算法：fq-codel

- 网络的路由算法 bbr+codel

[sentinel-go](https://github.com/alibaba/sentinel-golang)